{"version":3,"sources":["../src/index.ts","../src/connected_papers_client.ts","../src/consts.ts"],"sourcesContent":["import {ConnectedPapersClient} from './connected_papers_client';\n\nexport {ConnectedPapersClient};\nexport * from './graph';\n","import axios from 'axios';\r\n\r\nimport {accessToken, connectedPapersRestApi} from './consts';\r\nimport {type Graph, type PaperId} from './graph';\r\n\r\nexport enum GraphResponseStatuses {\r\n\tBAD_ID = 'BAD_ID',\r\n\tERROR = 'ERROR',\r\n\tNOT_IN_DB = 'NOT_IN_DB',\r\n\tOLD_GRAPH = 'OLD_GRAPH',\r\n\tFRESH_GRAPH = 'FRESH_GRAPH',\r\n\tIN_PROGRESS = 'IN_PROGRESS',\r\n\tQUEUED = 'QUEUED',\r\n\tBAD_TOKEN = 'BAD_TOKEN',\r\n\tBAD_REQUEST = 'BAD_REQUEST',\r\n\tOUT_OF_REQUESTS = 'OUT_OF_REQUESTS',\r\n}\r\n\r\nexport type GraphResponse = {\r\n\tstatus: GraphResponseStatuses;\r\n\tgraph_json?: Graph;\r\n\tprogress?: number;\r\n};\r\n\r\nconst sleepTimeBetweenChecks = 1000;\r\nconst sleepTimeAfterError = 5000;\r\n\r\nconst endResponseStatuses = [\r\n\tGraphResponseStatuses.BAD_ID,\r\n\tGraphResponseStatuses.ERROR,\r\n\tGraphResponseStatuses.NOT_IN_DB,\r\n\tGraphResponseStatuses.FRESH_GRAPH,\r\n\tGraphResponseStatuses.BAD_TOKEN,\r\n\tGraphResponseStatuses.BAD_REQUEST,\r\n\tGraphResponseStatuses.OUT_OF_REQUESTS,\r\n];\r\n\r\nexport class ConnectedPapersClient {\r\n\tprivate readonly accessToken: string;\r\n\tprivate readonly serverAddr: string;\r\n\r\n\tconstructor(args: {access_token?: string; server_addr?: string} = {}) {\r\n\t\tthis.accessToken = args.access_token ?? accessToken;\r\n\t\tthis.serverAddr = args.server_addr ?? connectedPapersRestApi;\r\n\t}\r\n\r\n\tpublic async * getGraphAsyncIterator(args: {paper_id: PaperId; fresh_only?: boolean; loop_until_fresh?: boolean}): AsyncGenerator<GraphResponse> {\r\n\t\tlet retryCounter = 3;\r\n\t\twhile (retryCounter > 0) {\r\n\t\t\ttry {\r\n\t\t\t\tlet newestGraph: Graph | undefined;\r\n\t\t\t\twhile (true) {\r\n\t\t\t\t\t// eslint-disable-next-line no-await-in-loop\r\n\t\t\t\t\tconst resp = await axios.get(\r\n\t\t\t\t\t\t`${this.serverAddr}/papers-api/graph/${Number(args.fresh_only ?? false)}/${args.paper_id}`,\r\n\t\t\t\t\t\t{headers: {'X-Api-Key': this.accessToken}},\r\n\t\t\t\t\t);\r\n\t\t\t\t\tif (resp.status !== 200) {\r\n\t\t\t\t\t\tthrow new Error(`Bad response: ${resp.status}`);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment\r\n\t\t\t\t\tconst {data} = resp;\r\n\t\t\t\t\tif (!data) {\r\n\t\t\t\t\t\tthrow new Error(`Bad response: ${resp.status}`);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-argument\r\n\t\t\t\t\tif (!Object.values(GraphResponseStatuses).includes(data.status)) {\r\n\t\t\t\t\t\tdata.status = GraphResponseStatuses.ERROR;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\targs.fresh_only = true;\r\n\t\t\t\t\tconst response: GraphResponse = data as GraphResponse;\r\n\t\t\t\t\tif (response.graph_json) {\r\n\t\t\t\t\t\tnewestGraph = response.graph_json;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// eslint-disable-next-line no-constant-binary-expression\r\n\t\t\t\t\tif (endResponseStatuses.includes(response.status) || ((!args.loop_until_fresh) ?? true)) {\r\n\t\t\t\t\t\tyield response;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tresponse.graph_json = newestGraph;\r\n\t\t\t\t\tyield response;\r\n\t\t\t\t\t// eslint-disable-next-line no-await-in-loop, no-promise-executor-return\r\n\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, sleepTimeBetweenChecks));\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\tretryCounter -= 1;\r\n\t\t\t\tif (retryCounter === 0) {\r\n\t\t\t\t\tthrow e;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// eslint-disable-next-line no-await-in-loop, no-promise-executor-return\r\n\t\t\t\tawait new Promise(resolve => setTimeout(resolve, sleepTimeAfterError));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async getGraph(args: {paper_id: PaperId; fresh_only?: boolean}): Promise<GraphResponse> {\r\n\t\tconst generator = this.getGraphAsyncIterator(args);\r\n\t\tlet result: GraphResponse = {\r\n\t\t\tstatus: GraphResponseStatuses.ERROR,\r\n\t\t\t// eslint-disable-next-line @typescript-eslint/naming-convention\r\n\t\t\tgraph_json: undefined,\r\n\t\t\tprogress: undefined,\r\n\t\t};\r\n\t\tfor await (const response of generator) {\r\n\t\t\tresult = response;\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t}\r\n\r\n\tpublic async getRemainingUsages(): Promise<number> {\r\n\t\ttry {\r\n\t\t\tconst response = await axios.get(`${this.serverAddr}/papers-api/remaining-usages`, {\r\n\t\t\t\theaders: {'X-Api-Key': this.accessToken},\r\n\t\t\t});\r\n\r\n\t\t\tif (response.status !== 200) {\r\n\t\t\t\tthrow new Error(`Bad response: ${response.status}`);\r\n\t\t\t}\r\n\r\n\t\t\tswitch (typeof response.data.remaining_uses) {\r\n\t\t\t\tcase 'number':\r\n\t\t\t\t\treturn response.data.remaining_uses as number;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthrow new Error(`Bad response: ${JSON.stringify(response)}`);\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\t// Handle error as needed\r\n\t\t\tconsole.error(error);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic async getFreeAccessPapers(): Promise<PaperId[]> {\r\n\t\ttry {\r\n\t\t\tconst response = await axios.get(`${this.serverAddr}/papers-api/free-access-papers`, {\r\n\t\t\t\theaders: {'X-Api-Key': this.accessToken},\r\n\t\t\t});\r\n\r\n\t\t\tif (response.status !== 200) {\r\n\t\t\t\tthrow new Error(`Bad response: ${response.status}`);\r\n\t\t\t}\r\n\r\n\t\t\treturn response.data.papers as PaperId[];\r\n\t\t} catch (error) {\r\n\t\t\t// Handle error as needed\r\n\t\t\tconsole.error(error);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n}\r\n","const testToken = 'TEST_TOKEN';\r\nconst defaultServerAddress = 'https://rest.prod.connectedpapers.com';\r\n\r\nexport const accessToken = process.env.CONNECTED_PAPERS_API_KEY ?? testToken;\r\nexport const connectedPapersRestApi = process.env.CONNECTED_PAPERS_REST_API ?? defaultServerAddress;\r\n"],"mappings":"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","names":["_a","GraphResponseStatuses","_a","axios"]}